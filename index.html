<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>P2P Chat (No Server)</title>
</head>
<body>
  <h2>2-Person P2P Chat (No Server)</h2>

  <textarea id="signal" placeholder="Copy/paste offer/answer here" style="width:100%;height:100px;"></textarea>
  <br>
  <button id="createOffer">Create Offer</button>
  <button id="createAnswer">Create Answer</button>
  <button id="setAnswer">Set Remote Answer</button>

  <div id="chat" style="display:none; border:1px solid #ccc; padding:10px; width:300px; height:300px; overflow:auto;"></div>
  <div id="controls" style="display:none; margin-top:10px;">
    <input id="msg" placeholder="Type a message" />
    <button id="send">Send</button>
    <input type="file" id="file" />
  </div>

  <script>
    let pc, dataChannel;

    function log(msg) {
      const chat = document.getElementById('chat');
      const div = document.createElement('div');
      div.textContent = msg;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function setupConnection() {
      document.getElementById('chat').style.display = 'block';
      document.getElementById('controls').style.display = 'block';

      dataChannel.onmessage = e => {
        try {
          let data = JSON.parse(e.data);
          if (data.type === 'text') log("Them: " + data.text);
          if (data.type === 'image') {
            let img = document.createElement('img');
            img.src = data.url;
            img.style.maxWidth = '100%';
            chat.appendChild(img);
          }
        } catch {
          log("Them: " + e.data);
        }
      };

      document.getElementById('send').onclick = () => {
        const text = document.getElementById('msg').value;
        if (text) {
          dataChannel.send(JSON.stringify({ type:'text', text }));
          log("Me: " + text);
          document.getElementById('msg').value = '';
        }
      };

      document.getElementById('file').onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          dataChannel.send(JSON.stringify({ type:'image', url: reader.result }));
          let img = document.createElement('img');
          img.src = reader.result;
          img.style.maxWidth = '100%';
          document.getElementById('chat').appendChild(img);
        };
        reader.readAsDataURL(file);
      };
    }

    document.getElementById('createOffer').onclick = async () => {
      pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
      dataChannel = pc.createDataChannel("chat");
      dataChannel.onopen = setupConnection;
      pc.onicecandidate = e => {
        if (!e.candidate) {
          document.getElementById('signal').value = JSON.stringify(pc.localDescription);
        }
      };
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
    };

    document.getElementById('createAnswer').onclick = async () => {
      pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
      pc.ondatachannel = e => {
        dataChannel = e.channel;
        dataChannel.onopen = setupConnection;
      };
      pc.onicecandidate = e => {
        if (!e.candidate) {
          document.getElementById('signal').value = JSON.stringify(pc.localDescription);
        }
      };
      const offer = JSON.parse(document.getElementById('signal').value);
      await pc.setRemoteDescription(offer);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
    };

    document.getElementById('setAnswer').onclick = async () => {
      const answer = JSON.parse(document.getElementById('signal').value);
      await pc.setRemoteDescription(answer);
    };
  </script>
</body>
</html>

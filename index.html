<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anonymous Real-Time Messenger</title>
  <style>
    /* Styles same as before for layout and appearance */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.15);
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    .header {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      padding: 25px;
      text-align: center;
    }
    .header h1 { font-size: 2.2em; margin-bottom: 8px; }
    .setup-section { padding: 40px; text-align: center; }
    .room-setup {}
    .input-group { margin: 20px 0; }
    .input-group label {
      display: block; margin-bottom: 8px; font-weight: 600; color: #333;
    }
    .room-code-input, .message-input {
      width: 100%; max-width: 450px; padding: 18px; border: 2px solid #e0e0e0;
      border-radius: 25px; font-size: 16px; margin: 10px 0; outline: none;
      transition: all 0.3s ease;
    }
    .room-code-input:focus, .message-input:focus {
      border-color: #667eea;
      box-shadow: 0 0 15px rgba(102,126,234,0.3);
      transform: translateY(-2px);
    }
    .btn {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white; border: none; padding: 18px 35px; border-radius: 25px;
      cursor: pointer; font-size: 16px; font-weight: 600; margin: 10px;
      transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102,126,234,0.3);
    }
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(102,126,234,0.4);
    }
    .btn:active { transform: translateY(0); }
    .btn.secondary {
      background: linear-gradient(45deg, #28a745, #20c997);
    }
    .btn.danger {
      background: linear-gradient(45deg, #dc3545, #c82333);
    }
    .chat-area { display: none; padding: 25px; }
    .room-info {
      background: linear-gradient(135deg,#f8f9fa,#e9ecef);
      padding: 20px; margin-bottom: 25px; border-radius: 15px;
      text-align: center; border-left: 5px solid #667eea;
    }
    .room-info h3 { color: #495057; margin-bottom: 10px; }
    .room-code {
      font-family: monospace; font-size: 1.2em; font-weight: bold; color: #667eea;
      background: white; padding: 10px 20px; border-radius: 25px; display: inline-block;
      margin: 10px 0; border: 2px solid #667eea;
    }
    .messages {
      height: 450px; overflow-y: auto; border: 2px solid #e9ecef; border-radius: 15px;
      padding: 20px; margin-bottom: 20px; background: linear-gradient(135deg,#f8f9fa,#ffffff);
      scroll-behavior: smooth;
    }
    .message {
      margin: 15px 0; padding: 15px 20px; border-radius: 20px; max-width: 75%; word-wrap: break-word;
      animation: messageSlide 0.3s ease-in; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    @keyframes messageSlide {
      from { opacity: 0; transform: translateY(20px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .message.own {
      background: linear-gradient(135deg, #667eea, #764ba2); color: white;
      margin-left: auto; text-align: right;
    }
    .message.other {
      background: linear-gradient(135deg, #e9ecef, #f8f9fa);
      color: #333; border-left: 4px solid #667eea;
    }
    .message-form { display: flex; gap: 15px; align-items: center; }
    .message-input { flex: 1; margin: 0; }
    .file-input { display: none; }
    .file-btn {
      background: linear-gradient(45deg, #28a745, #20c997);
      padding: 18px; border-radius: 50%; cursor: pointer; display: flex; align-items: center;
      justify-content: center; min-width: 55px; min-height: 55px; font-size: 20px;
      transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(40,167,69,0.3);
    }
    .file-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(40,167,69,0.4);}
    .timestamp { font-size: 11px; opacity: 0.8; margin-top: 8px; font-style: italic; }
    .image-preview {
      max-width: 250px; max-height: 250px; border-radius: 15px; margin-top: 10px;
      cursor: pointer; transition: transform 0.3s ease;
    }
    .image-preview:hover { transform: scale(1.05);}
    .notification {
      position: fixed; top: 25px; right: 25px; background: linear-gradient(45deg,#28a745,#20c997);
      color: white; padding: 15px 25px; border-radius: 25px; display: none; z-index: 1000;
      box-shadow: 0 8px 25px rgba(40,167,69,0.3); animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from {transform: translateX(100%); opacity: 0;}
      to {transform: translateX(0); opacity: 1;}
    }
    .notification.error {
      background: linear-gradient(45deg, #dc3545, #c82333);
    }
    .status {
      text-align: center; padding: 10px; font-style: italic; color: #6c757d;
    }
    .online-indicator {
      display: inline-block; width: 10px; height: 10px; background: #28a745; border-radius: 50%;
      margin-right: 8px; animation: pulse 2s infinite;
    }
    @keyframes pulse { 0%{opacity:1;} 50%{opacity:0.5;} 100%{opacity:1;}}
    @media (max-width: 768px) {
      .container { margin: 10px; border-radius: 15px;}
      .message { max-width: 90%; }
      .setup-section { padding: 25px; }
      .messages { height: 350px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîí Anonymous Real-Time Messenger</h1>
      <p>Send messages and images anonymously in real-time</p>
    </div>
    <!-- Room Setup Section -->
    <div class="setup-section room-setup" id="roomSetup">
      <h2>üö™ Enter Chat Room</h2>
      <p>Create or join a room to start anonymous messaging</p>
      <div class="input-group">
        <label for="roomCode">Room Code:</label>
        <input type="text" class="room-code-input" id="roomCode" placeholder="Enter room code or generate new">
      </div>
      <button class="btn" onclick="joinRoom()">Join Room</button>
      <button class="btn secondary" onclick="generateRoomCode()">Generate New Room</button>
    </div>
    <!-- Chat Area -->
    <div class="chat-area" id="chatArea">
      <div class="room-info">
        <h3><span class="online-indicator"></span>Connected to Room</h3>
        <div class="room-code" id="currentRoom"></div>
        <p>Share this code with others to join this anonymous chat</p>
        <button class="btn" onclick="copyRoomCode()" style="font-size:14px; padding:10px 20px;">üìã Copy Code</button>
        <button class="btn danger" onclick="leaveRoom()" style="font-size:14px; padding:10px 20px;">üö™ Leave Room</button>
      </div>
      <div class="messages" id="messages">
        <div class="status">üîÑ Loading messages...</div>
      </div>
      <div class="message-form">
        <input type="file" class="file-input" id="fileInput" accept="image/*">
        <button class="file-btn" onclick="document.getElementById('fileInput').click()" title="Send Image">üì∑</button>
        <input type="text" class="message-input" id="messageInput" placeholder="Type your anonymous message..." maxlength="500">
        <button class="btn" onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>
  <div class="notification" id="notification"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
  
  <script>
    // Firebase config (your project)
    var firebaseConfig = {
      apiKey: "AIzaSyBhpJ1yAo92xLx6L3GyTVTuZsOXYYDZKWs",
      authDomain: "anon-ac806.firebaseapp.com",
      databaseURL: "https://anon-ac806-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "anon-ac806",
      storageBucket: "anon-ac806.appspot.com",
      messagingSenderId: "692292101984",
      appId: "1:692292101984:web:15ad6efcd0bc1411982005",
      measurementId: "G-1888WQV1PV"
    };
    var app = firebase.initializeApp(firebaseConfig);
    var database = firebase.database();

    let currentRoom = '';
    let userId = 'anon_' + Math.random().toString(36).substr(2, 12);
    let messagesRef = null;

    function generateRoomCode() {
      const code = 'ROOM-' + Math.random().toString(36).substr(2, 6).toUpperCase();
      document.getElementById('roomCode').value = code;
      showNotification('üé≤ Room code generated!');
    }
    function joinRoom() {
      const roomCode = document.getElementById('roomCode').value.trim();
      if (!roomCode) {
        showNotification('‚ùå Please enter a room code', 'error');
        return;
      }
      currentRoom = roomCode;
      document.getElementById('currentRoom').textContent = currentRoom;
      messagesRef = database.ref('rooms/' + currentRoom + '/messages');
      document.querySelector('.room-setup').style.display = 'none';
      document.getElementById('chatArea').style.display = 'block';
      listenForMessages();
      sendSystemMessage(userId.substr(5, 4) + ' joined the chat');
      showNotification('üö™ Joined room: ' + roomCode);
    }
    function listenForMessages() {
      if (!messagesRef) {
        console.error('Messages ref not set');
        return;
      }
      messagesRef.off();
      document.getElementById('messages').innerHTML = '';
      messagesRef.on('child_added', function (snapshot) {
        const messageData = snapshot.val();
        displayMessage(messageData, messageData.sender === userId);
      });
    }
    function sendMessage() {
      const messageInput = document.getElementById('messageInput');
      const message = messageInput.value.trim();
      if (!message || !messagesRef) return;
      const messageData = {
        id: Date.now() + '_' + Math.random(),
        text: message,
        sender: userId,
        senderName: userId.substr(5, 4),
        timestamp: Date.now(),
        type: 'text',
      };
      try {
        messagesRef.push(messageData);
        messageInput.value = '';
      } catch (error) {
        console.error('Error sending message:', error);
        showNotification('Error sending message', 'error');
      }
    }
    function sendSystemMessage(text) {
      if (!messagesRef) return;
      const messageData = {
        id: Date.now() + '_system',
        text: text,
        sender: 'system',
        senderName: 'System',
        timestamp: Date.now(),
        type: 'system',
      };
      messagesRef.push(messageData);
    }
    document.getElementById('fileInput').addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (!file) return;
      if (file.size > 5 * 1024 * 1024) { // 5MB limit
        showNotification('‚ùå File too large (max 5MB)', 'error');
        return;
      }
      const reader = new FileReader();
      reader.onload = function (e) {
        const messageData = {
          id: Date.now() + '_' + Math.random(),
          text: file.name,
          fileData: e.target.result,
          fileType: file.type,
          sender: userId,
          senderName: userId.substr(5, 4),
          timestamp: Date.now(),
          type: 'file',
        };
        try {
          messagesRef.push(messageData);
          showNotification('üìÅ File sent!');
        } catch (error) {
          console.error('Error sending file:', error);
          showNotification('Error sending file', 'error');
        }
      };
      reader.readAsDataURL(file);
      event.target.value = '';
    });
    function displayMessage(messageData, isOwn) {
      const messagesContainer = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      if (messageData.type === 'system') {
        messageDiv.className = 'status';
        messageDiv.textContent = messageData.text;
        messagesContainer.appendChild(messageDiv);
        scrollToBottom();
        return;
      }
      messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
      let content = '';
      const time = new Date(messageData.timestamp).toLocaleTimeString();
      const senderLabel = isOwn ? 'You' : 'Anonymous ' + messageData.senderName;
      if (messageData.type === 'file' && messageData.fileType && messageData.fileType.startsWith('image/')) {
        content = `
          <div><strong>${senderLabel}:</strong></div>
          <div>üì∑ ${messageData.text}</div>
          <img src="${messageData.fileData}" alt="${messageData.text}" class="image-preview" onclick="window.open(this.src)">
          <div class="timestamp">${time}</div>
        `;
      } else if (messageData.type === 'file') {
        content = `
          <div><strong>${senderLabel}:</strong></div>
          <div>üìé ${messageData.text}</div>
          <a href="${messageData.fileData}" download="${messageData.text}">üì• Download</a>
          <div class="timestamp">${time}</div>
        `;
      } else {
        content = `
          <div><strong>${senderLabel}:</strong></div>
          <div>${messageData.text}</div>
          <div class="timestamp">${time}</div>
        `;
      }
      messageDiv.innerHTML = content;
      messagesContainer.appendChild(messageDiv);
      scrollToBottom();
    }
    function scrollToBottom() {
      const messages = document.getElementById('messages');
      messages.scrollTop = messages.scrollHeight;
    }
    function copyRoomCode() {
      navigator.clipboard.writeText(currentRoom).then(function () {
        showNotification('üìã Room code copied!');
      });
    }
    function leaveRoom() {
      if (messagesRef) {
        sendSystemMessage(userId.substr(5, 4) + ' left the chat');
        messagesRef.off();
      }
      currentRoom = '';
      messagesRef = null;
      document.getElementById('chatArea').style.display = 'none';
      document.querySelector('.room-setup').style.display = 'block';
      document.getElementById('roomCode').value = '';
      document.getElementById('messages').innerHTML = '<div class="status">üîÑ Loading messages...</div>';
      showNotification('üëã Left the room');
    }
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type === 'error' ? 'error' : ''}`;
      notification.style.display = 'block';
      setTimeout(() => {
        notification.style.display = 'none';
      }, 4000);
    }
    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('roomCode').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') joinRoom();
      });
      document.getElementById('messageInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') sendMessage();
      });
    });
    window.addEventListener('beforeunload', function () {
      if (messagesRef && currentRoom) {
        sendSystemMessage(userId.substr(5, 4) + ' left the chat');
      }
    });
  </script>
</body>
</html>

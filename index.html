<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anonymous Dark Chat</title>
  <style>
    * {
      margin: 0; padding: 0; box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #121212 0%, #1e1e1e 100%);
      color: #eee;
      min-height: 100vh; padding: 15px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #222;
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.8);
      overflow: hidden;
      backdrop-filter: saturate(180%) blur(15px);
      color: #eee;
      display: flex;
      flex-direction: column;
      height: 90vh;
    }
    .header {
      background: linear-gradient(45deg, #3700b3, #6200ea);
      color: #fff;
      padding: 25px;
      text-align: center;
      user-select: none;
      flex-shrink: 0;
    }
    .header h1 {
      font-size: 2.2em;
      margin-bottom: 8px;
    }
    .setup-section {
      padding: 40px 20px;
      text-align: center;
      flex-shrink: 0;
      background: #1a1a1a;
    }
    .room-setup {}
    .input-group {
      margin: 20px 0;
    }
    .input-group label {
      display: block; margin-bottom: 8px; font-weight: 600; color: #ccc;
    }
    .room-code-input, .message-input {
      width: 100%;
      max-width: 450px;
      padding: 16px 20px;
      border: 2px solid #444;
      border-radius: 25px;
      font-size: 16px;
      background: #121212;
      color: #eee;
      outline: none;
      transition: all 0.3s ease;
      caret-color: #bb86fc;
    }
    .room-code-input:focus, .message-input:focus {
      border-color: #bb86fc;
      box-shadow: 0 0 15px rgba(187, 134, 252, 0.7);
      transform: translateY(-2px);
    }
    .btn {
      background: linear-gradient(45deg, #6200ea, #3700b3);
      color: white;
      border: none;
      padding: 15px 35px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin: 10px 5px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(98, 0, 234, 0.6);
      user-select: none;
      flex-shrink: 0;
    }
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(98, 0, 234, 0.8);
    }
    .btn:active {
      transform: translateY(0);
    }
    .btn.secondary {
      background: linear-gradient(45deg, #03dac6, #018786);
      box-shadow: 0 4px 15px rgba(3, 218, 198, 0.6);
    }
    .btn.danger {
      background: linear-gradient(45deg, #cf6679, #b00020);
      box-shadow: 0 4px 15px rgba(207, 102, 121, 0.6);
    }
    .chat-area {
      display: flex;
      flex-direction: column;
      padding: 20px;
      background: #121212;
      border-top: 1px solid #333;
      flex-grow: 1;
      height: auto;
      min-height: 0;
    }
    .room-info {
      background: #222;
      padding: 15px 20px;
      margin-bottom: 20px;
      border-radius: 15px;
      border-left: 5px solid #bb86fc;
      text-align: center;
      color: #ccc;
      user-select: none;
      flex-shrink: 0;
    }
    .room-info h3 {
      color: #eee;
      margin-bottom: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }
    .room-code {
      font-family: monospace;
      font-size: 1.2em;
      font-weight: bold;
      color: #bb86fc;
      background: #121212;
      padding: 10px 20px;
      border-radius: 25px;
      display: inline-block;
      margin: 10px 0;
      border: 2px solid #bb86fc;
      user-select: text;
    }
    .messages {
      flex-grow: 1;
      min-height: 0;
      overflow-y: auto;
      border: 2px solid #333;
      border-radius: 15px;
      padding: 15px 25px;
      margin-bottom: 15px;
      background: linear-gradient(135deg, #1e1e1e, #121212);
      scroll-behavior: smooth;
      color: #ddd;
      font-size: 15px;
      line-height: 1.4;
    }
    .message {
      margin: 12px 0;
      padding: 12px 18px;
      border-radius: 20px;
      max-width: 75%;
      word-wrap: break-word;
      animation: messageSlide 0.3s ease-in;
      box-shadow: 0 2px 8px rgba(0,0,0,0.6);
      font-weight: 500;
      user-select: text;
    }
    @keyframes messageSlide {
      from { opacity: 0; transform: translateY(20px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .message.own {
      background: linear-gradient(135deg, #bb86fc, #3700b3);
      color: white;
      margin-left: auto;
      text-align: right;
      box-shadow: 0 3px 12px rgba(187, 134, 252, 0.8);
    }
    .message.other {
      background: #333;
      color: #ddd;
      border-left: 4px solid #bb86fc;
      box-shadow: 0 2px 12px rgba(51, 51, 51, 0.8);
    }
    .message-form {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-shrink: 0;
    }
    .message-input {
      flex: 1;
      margin: 0;
      padding: 14px 18px;
      font-size: 16px;
      border-radius: 25px;
      border: 2px solid #444;
      background: #121212;
      color: #eee;
      outline: none;
      caret-color: #bb86fc;
      transition: all 0.3s ease;
    }
    .message-input:focus {
      border-color: #bb86fc;
      box-shadow: 0 0 12px rgba(187, 134, 252, 0.7);
    }
    .file-input {
      display: none;
    }
    .file-btn {
      background: linear-gradient(45deg, #03dac6, #018786);
      padding: 16px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 55px;
      min-height: 55px;
      font-size: 20px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(3, 218, 198, 0.6);
      color: #121212;
      user-select: none;
    }
    .file-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(3, 218, 198, 0.8);
    }
    .timestamp {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 6px;
      font-style: italic;
      color: #ccc;
    }
    .image-preview {
      max-width: 250px;
      max-height: 250px;
      border-radius: 15px;
      margin-top: 10px;
      cursor: pointer;
      transition: transform 0.3s ease;
      border: 2px solid #444;
      display: block;
    }
    .image-preview:hover {
      transform: scale(1.05);
      border-color: #bb86fc;
    }
    .notification {
      position: fixed;
      top: 25px;
      right: 25px;
      background: linear-gradient(45deg, #03dac6, #018786);
      color: #121212;
      padding: 15px 25px;
      border-radius: 25px;
      display: none;
      z-index: 1000;
      box-shadow: 0 8px 25px rgba(3, 218, 198, 0.6);
      user-select: none;
      font-weight: 600;
    }
    .notification.error {
      background: linear-gradient(45deg, #cf6679, #b00020);
      color: #eee;
      box-shadow: 0 8px 25px rgba(207, 102, 121, 0.8);
    }
    .status {
      text-align: center;
      padding: 12px;
      font-style: italic;
      color: #888;
      user-select: none;
    }
    .online-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      background: #03dac6;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 15px;
        height: 100vh;
      }
      .message {
        max-width: 90%;
      }
      .setup-section {
        padding: 25px 15px;
      }
      .messages {
        height: 100%;
        min-height: 0;
        padding: 15px;
      }
      .chat-area {
        padding: 15px;
      }
      .btn, .file-btn {
        padding: 14px 25px;
        font-size: 14px;
      }
      .message-input {
        font-size: 14px;
        padding: 12px 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Anonymous</h1>
    </div>
    <!-- Room Setup Section -->
    <div class="setup-section room-setup" id="roomSetup">
      <h2>🚪 Enter Chat Room</h2>
      <p>Create or join a room to start anonymous messaging</p>
      <div class="input-group">
        <label for="roomCode">Room Code:</label>
        <input type="text" class="room-code-input" id="roomCode" placeholder="Enter room code or generate new" />
      </div>
      <button class="btn" onclick="joinRoom()">Join Room</button>
      <button class="btn secondary" onclick="generateRoomCode()">Generate New Room</button>
    </div>
    <!-- Chat Area -->
    <div class="chat-area" id="chatArea" style="display:none;">
      <div class="room-info">
        <h3><span class="online-indicator"></span>Connected to Room</h3>
        <div class="room-code" id="currentRoom"></div>
        <p>Share this code with others to join this anonymous chat</p>
        <button class="btn" onclick="copyRoomCode()" style="font-size:14px; padding:10px 20px;">📋 Copy Code</button>
        <button class="btn danger" onclick="leaveRoom()" style="font-size:14px; padding:10px 20px;">🚪 Leave Room</button>
      </div>
      <div class="messages" id="messages">
        <div class="status">🔄 Loading messages...</div>
      </div>
      <div class="message-form">
        <input type="file" class="file-input" id="fileInput" accept="image/*" />
        <button class="file-btn" onclick="document.getElementById('fileInput').click()" title="Send Image">📷</button>
        <input type="text" class="message-input" id="messageInput" placeholder="Type your anonymous message..." maxlength="500" />
        <button class="btn" onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>
  <div class="notification" id="notification"></div>

  <!-- Firebase and JS unchanged except minor fixes -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyBhpJ1yAo92xLx6L3GyTVTuZsOXYYDZKWs",
      authDomain: "anon-ac806.firebaseapp.com",
      databaseURL: "https://anon-ac806-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "anon-ac806",
      storageBucket: "anon-ac806.appspot.com",
      messagingSenderId: "692292101984",
      appId: "1:692292101984:web:15ad6efcd0bc1411982005",
      measurementId: "G-1888WQV1PV"
    };
    var app = firebase.initializeApp(firebaseConfig);
    var database = firebase.database();

    let currentRoom = '';
    let userId = 'anon_' + Math.random().toString(36).substr(2, 12);
    let messagesRef = null;

    // Preserve room and message area visibility after refresh if room code exists in localStorage
    document.addEventListener('DOMContentLoaded', function () {
      const savedRoom = localStorage.getItem('anonChatRoom');
      if (savedRoom) {
        document.getElementById('roomCode').value = savedRoom;
        joinRoom(true);
      }
      document.getElementById('roomCode').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') joinRoom();
      });
      document.getElementById('messageInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') sendMessage();
      });
    });

    function generateRoomCode() {
      const code = 'ROOM-' + Math.random().toString(36).substr(2, 6).toUpperCase();
      document.getElementById('roomCode').value = code;
      showNotification('🎲 Room code generated!');
    }

    function joinRoom(isAutoJoin = false) {
      const roomCode = document.getElementById('roomCode').value.trim();
      if (!roomCode) {
        showNotification('❌ Please enter a room code', 'error');
        return;
      }
      currentRoom = roomCode;
      localStorage.setItem('anonChatRoom', currentRoom);
      document.getElementById('currentRoom').textContent = currentRoom;
      messagesRef = database.ref('rooms/' + currentRoom + '/messages');
      document.querySelector('.room-setup').style.display = 'none';
      document.getElementById('chatArea').style.display = 'flex';

      listenForMessages();

      if (!isAutoJoin) {
        sendSystemMessage(userId.substr(5, 4) + ' joined the chat');
        showNotification('🚪 Joined room: ' + roomCode);
      }
    }

    function listenForMessages() {
      if (!messagesRef) {
        console.error('Messages ref not set');
        return;
      }
      messagesRef.off();
      const messagesContainer = document.getElementById('messages');
      messagesContainer.innerHTML = '';
      messagesRef.on('child_added', function (snapshot) {
        const messageData = snapshot.val();
        displayMessage(messageData, messageData.sender === userId);
      }, function (error) {
        console.error('Firebase listen error:', error);
      });
    }

    function sendMessage() {
      const messageInput = document.getElementById('messageInput');
      const message = messageInput.value.trim();
      if (!message || !messagesRef) return;
      const messageData = {
        id: Date.now() + '_' + Math.random(),
        text: message,
        sender: userId,
        senderName: userId.substr(5, 4),
        timestamp: Date.now(),
        type: 'text',
      };
      try {
        messagesRef.push(messageData).then(() => {
          messageInput.value = '';
        }).catch(error => {
          console.error('Error sending message:', error);
          showNotification('Error sending message', 'error');
        });
      } catch (error) {
        console.error('Error sending message:', error);
        showNotification('Error sending message', 'error');
      }
    }

    function sendSystemMessage(text) {
      if (!messagesRef) return;
      const messageData = {
        id: Date.now() + '_system',
        text: text,
        sender: 'system',
        senderName: 'System',
        timestamp: Date.now(),
        type: 'system',
      };
      messagesRef.push(messageData);
    }

    document.getElementById('fileInput').addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.size > 5 * 1024 * 1024) {
        showNotification('❌ File too large (max 5MB)', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const messageData = {
          id: Date.now() + '_' + Math.random(),
          text: file.name,
          fileData: e.target.result,
          fileType: file.type,
          sender: userId,
          senderName: userId.substr(5, 4),
          timestamp: Date.now(),
          type: 'file',
        };
        try {
          messagesRef.push(messageData).then(() => {
            showNotification('📁 File sent!');
          }).catch(error => {
            console.error('Error sending file:', error);
            showNotification('Error sending file', 'error');
          });
        } catch (error) {
          console.error('Error sending file:', error);
          showNotification('Error sending file', 'error');
        }
      };
      reader.readAsDataURL(file);
      event.target.value = '';
    });

    function displayMessage(messageData, isOwn) {
      const messagesContainer = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      if (messageData.type === 'system') {
        messageDiv.className = 'status';
        messageDiv.textContent = messageData.text;
        messagesContainer.appendChild(messageDiv);
        scrollToBottom();
        return;
      }
      messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
      let content = '';
      const time = new Date(messageData.timestamp).toLocaleTimeString();
      const senderLabel = isOwn ? 'You' : 'Anonymous ' + messageData.senderName;
      if (messageData.type === 'file' && messageData.fileType && messageData.fileType.startsWith('image/')) {
        content = `
          <div><strong>${senderLabel}:</strong></div>
          <div>📷 ${messageData.text}</div>
          <img src="${messageData.fileData}" alt="${messageData.text}" class="image-preview" onclick="window.open(this.src)">
          <div class="timestamp">${time}</div>
        `;
      } else if (messageData.type === 'file') {
        content = `
          <div><strong>${senderLabel}:</strong></div>
          <div>📎 ${messageData.text}</div>
          <a href="${messageData.fileData}" download="${messageData.text}">📥 Download</a>
          <div class="timestamp">${time}</div>
        `;
      } else {
        content = `
          <div><strong>${senderLabel}:</strong></div>
          <div>${messageData.text}</div>
          <div class="timestamp">${time}</div>
        `;
      }
      messageDiv.innerHTML = content;
      messagesContainer.appendChild(messageDiv);
      scrollToBottom();
    }

    function scrollToBottom() {
      const messages = document.getElementById('messages');
      messages.scrollTop = messages.scrollHeight;
    }

    function copyRoomCode() {
      navigator.clipboard.writeText(currentRoom).then(function () {
        showNotification('📋 Room code copied!');
      });
    }

    function leaveRoom() {
      if (messagesRef) {
        sendSystemMessage(userId.substr(5, 4) + ' left the chat');
        messagesRef.off();
      }
      localStorage.removeItem('anonChatRoom');
      currentRoom = '';
      messagesRef = null;
      document.getElementById('chatArea').style.display = 'none';
      document.querySelector('.room-setup').style.display = 'block';
      document.getElementById('roomCode').value = '';
      document.getElementById('messages').innerHTML = '<div class="status">🔄 Loading messages...</div>';
      showNotification('👋 Left the room');
    }

    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type === 'error' ? 'error' : ''}`;
      notification.style.display = 'block';
      setTimeout(() => {
        notification.style.display = 'none';
      }, 4000);
    }

    window.addEventListener('beforeunload', function () {
      if (messagesRef && currentRoom) {
        sendSystemMessage(userId.substr(5, 4) + ' left the chat');
      }
    });
  </script>
</body>
</html>

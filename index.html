<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2-Person P2P Chat</title>
</head>
<body>
  <h2>2-Person Temporary Chat (WebRTC P2P)</h2>

  <div>
    <input id="room" placeholder="Room ID" />
    <button id="create">Create Room</button>
    <button id="join">Join Room</button>
  </div>

  <div id="chat" style="display:none; border:1px solid #ccc; padding:10px; width:300px; height:300px; overflow:auto;"></div>

  <div id="controls" style="display:none; margin-top:10px;">
    <input id="msg" placeholder="Type a message" />
    <button id="send">Send</button>
    <input type="file" id="file" />
  </div>

  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <script>
    let peer, conn;

    const chatBox = document.getElementById('chat');
    const msgInput = document.getElementById('msg');

    function addMsg(text, from) {
      const div = document.createElement('div');
      div.textContent = (from ? from+": ":"") + text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function addImage(url, from) {
      const div = document.createElement('div');
      div.textContent = from ? from+": " : "";
      const img = document.createElement('img');
      img.src = url;
      img.style.maxWidth = '100%';
      div.appendChild(img);
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    document.getElementById('create').onclick = () => {
      const roomId = document.getElementById('room').value.trim();
      if (!roomId) return alert('Enter a Room ID');
      peer = new Peer(roomId, { host: 'peerjs.com', port: 443, secure: true });
      peer.on('open', id => {
        addMsg('Room created. Share ID: ' + id);
      });
      peer.on('connection', c => {
        conn = c;
        setupConn();
      });
    };

    document.getElementById('join').onclick = () => {
      const roomId = document.getElementById('room').value.trim();
      if (!roomId) return alert('Enter a Room ID');
      peer = new Peer(null, { host: 'peerjs.com', port: 443, secure: true });
      peer.on('open', id => {
        conn = peer.connect(roomId);
        conn.on('open', setupConn);
      });
    };

    function setupConn() {
      document.getElementById('chat').style.display = 'block';
      document.getElementById('controls').style.display = 'block';
      addMsg('Connected!');

      conn.on('data', data => {
        if (data.type === 'text') addMsg(data.text, 'Them');
        if (data.type === 'image') addImage(data.url, 'Them');
      });

      document.getElementById('send').onclick = () => {
        const text = msgInput.value;
        if (text && conn.open) {
          conn.send({ type:'text', text });
          addMsg(text, 'Me');
          msgInput.value = '';
        }
      };

      document.getElementById('file').onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          conn.send({ type:'image', url: reader.result });
          addImage(reader.result, 'Me');
        };
        reader.readAsDataURL(file);
      };
    }
  </script>
</body>
</html>
